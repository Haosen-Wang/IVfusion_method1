Epoch 1/5:   0%|▎                                                                     | 29/8100 [00:08<11:43, 11.47it/s]
当前学习率: 0.001000
⚠️  批次 1 检测到 NaN/Inf 损失，跳过此批次...
损失详情: {'total_loss_f': tensor(nan, device='cuda:2', grad_fn=<AddBackward0>), 'pixel_loss': tensor(nan, device='cuda:2', grad_fn=<MulBackward0>), 'gradient_loss': tensor(nan, device='cuda:2', grad_fn=<MulBackward0>), 'perceptual_loss': tensor(nan, device='cuda:2', grad_fn=<AddBackward0>), 'total_loss_vi': tensor(nan, device='cuda:2', grad_fn=<MulBackward0>), 'rec_i': tensor(nan, device='cuda:2', grad_fn=<MseLossBackward0>), 'rec_g': tensor(nan, device='cuda:2', grad_fn=<MseLossBackward0>), 'kl_loss_i': tensor(nan, device='cuda:2', grad_fn=<MulBackward0>), 'kl_loss_g': tensor(nan, device='cuda:2', grad_fn=<MulBackward0>), 'total_loss': tensor(nan, device='cuda:2', grad_fn=<AddBackward0>)}
⚠️  批次 2 内存不足，跳过...
⚠️  批次 3 内存不足，跳过...
⚠️  批次 4 内存不足，跳过...
⚠️  批次 5 内存不足，跳过...
⚠️  批次 6 内存不足，跳过...
⚠️  批次 7 内存不足，跳过...
⚠️  批次 8 内存不足，跳过...
⚠️  批次 9 内存不足，跳过...
⚠️  批次 10 内存不足，跳过...
⚠️  批次 11 内存不足，跳过...
⚠️  批次 12 内存不足，跳过...
⚠️  批次 13 内存不足，跳过...
⚠️  批次 14 内存不足，跳过...
⚠️  批次 15 内存不足，跳过...
⚠️  批次 16 内存不足，跳过...
⚠️  批次 17 内存不足，跳过...
⚠️  批次 18 内存不足，跳过...
⚠️  批次 19 内存不足，跳过...
⚠️  批次 20 内存不足，跳过...
⚠️  批次 21 内存不足，跳过...
⚠️  批次 22 内存不足，跳过...
⚠️  批次 23 内存不足，跳过...
⚠️  批次 24 内存不足，跳过...
⚠️  批次 25 内存不足，跳过...
⚠️  批次 26 内存不足，跳过...
⚠️  批次 27 内存不足，跳过...
⚠️  批次 28 内存不足，跳过...
⚠️  批次 29 内存不足，跳过...
⚠️  批次 30 内存不足，跳过...
⚠️  批次 31 内存不足，跳过...
⚠️  批次 32 内存不足，跳过...
⚠️  批次 33 内存不足，跳过...
⚠️  批次 34 内存不足，跳过...
⚠️  批次 35 内存不足，跳过...
⚠️  批次 36 内存不足，跳过...
⚠️  批次 37 内存不足，跳过...
⚠️  批次 38 内存不足，跳过...
⚠️  批次 39 内存不足，跳过...
⚠️  批次 40 内存不足，跳过...
⚠️  批次 41 内存不足，跳过...
⚠️  批次 42 内存不足，跳过...
⚠️  批次 43 内存不足，跳过...
⚠️  批次 44 内存不足，跳过...
⚠️  批次 45 内存不足，跳过...
⚠️  批次 46 内存不足，跳过...
⚠️  批次 47 内存不足，跳过...
⚠️  批次 48 内存不足，跳过...
⚠️  批次 49 内存不足，跳过...
⚠️  批次 50 内存不足，跳过...
⚠️  批次 51 内存不足，跳过...
⚠️  批次 52 内存不足，跳过...
⚠️  批次 53 内存不足，跳过...
⚠️  批次 54 内存不足，跳过...
⚠️  批次 55 内存不足，跳过...
⚠️  批次 56 内存不足，跳过...
⚠️  批次 57 内存不足，跳过...
⚠️  批次 58 内存不足，跳过...
⚠️  批次 59 内存不足，跳过...
⚠️  批次 60 内存不足，跳过...
⚠️  批次 61 内存不足，跳过...
⚠️  批次 62 内存不足，跳过...
⚠️  批次 63 内存不足，跳过...
⚠️  批次 64 内存不足，跳过...
⚠️  批次 65 内存不足，跳过...
⚠️  批次 66 内存不足，跳过...
⚠️  批次 67 内存不足，跳过...
⚠️  批次 68 内存不足，跳过...
⚠️  批次 69 内存不足，跳过...
⚠️  批次 70 内存不足，跳过...
Traceback (most recent call last):
  File "/home/user/1024_whs/IVfusion_method1/model/stage2/train.py", line 420, in <module>
    main(**config_dic)
  File "/home/user/1024_whs/IVfusion_method1/model/stage2/train.py", line 383, in main
    best_epoch, best_loss = train_model(
                            ^^^^^^^^^^^^
  File "/home/user/1024_whs/IVfusion_method1/model/stage2/train.py", line 137, in train_model
    epoch_loss = train_epoch_model(model, train_loader, criterion, optimizer, device_1, device_2, device_3, val_loader, pbar)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/user/1024_whs/IVfusion_method1/model/stage2/train.py", line 39, in train_epoch_model
    output, l, g, mu_l, sigma2_l, mu_g, sigma2_g = model(i_image, v_image, device_1, device_2, device_3)
                                                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/conda/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/conda/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/user/1024_whs/IVfusion_method1/model/stage2/model.py", line 44, in forward
    l,mu_l,sigma2_l = self.I_encoder_decoder(i)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/conda/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/conda/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/user/1024_whs/IVfusion_method1/model/stage2/model.py", line 17, in forward
    x=self.encoder(x)
      ^^^^^^^^^^^^^^^
  File "/opt/conda/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/conda/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/user/1024_whs/IVfusion_method1/model/stage2/component.py", line 19, in forward
    x=self.model(x)
      ^^^^^^^^^^^^^
  File "/opt/conda/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/conda/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/conda/lib/python3.11/site-packages/torch/nn/modules/container.py", line 240, in forward
    input = module(input)
            ^^^^^^^^^^^^^
  File "/opt/conda/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/conda/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/user/1024_whs/IVfusion_method1/model/stage2/../restormer/restormer_arch.py", line 251, in forward
    latent = self.latent(inp_enc_level4)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/conda/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/conda/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/conda/lib/python3.11/site-packages/torch/nn/modules/container.py", line 240, in forward
    input = module(input)
            ^^^^^^^^^^^^^
  File "/opt/conda/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/conda/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/user/1024_whs/IVfusion_method1/model/stage2/../restormer/restormer_arch.py", line 141, in forward
    x = x + self.attn(self.norm1(x))
                      ^^^^^^^^^^^^^
  File "/opt/conda/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/conda/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/user/1024_whs/IVfusion_method1/model/stage2/../restormer/restormer_arch.py", line 64, in forward
    return to_4d(self.body(to_3d(x)), h, w)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/user/1024_whs/IVfusion_method1/model/stage2/../restormer/restormer_arch.py", line 17, in to_4d
    return rearrange(x, 'b (h w) c -> b c h w',h=h,w=w)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/user/.local/lib/python3.11/site-packages/einops/einops.py", line 600, in rearrange
    return reduce(tensor, pattern, reduction="rearrange", **axes_lengths)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/user/.local/lib/python3.11/site-packages/einops/einops.py", line 532, in reduce
    return _apply_recipe(
           ^^^^^^^^^^^^^^
  File "/home/user/.local/lib/python3.11/site-packages/einops/einops.py", line 243, in _apply_recipe
    tensor = backend.reshape(tensor, init_shapes)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/user/.local/lib/python3.11/site-packages/einops/_backends.py", line 93, in reshape
    return x.reshape(shape)
           ^^^^^^^^^^^^^^^^
KeyboardInterrupt
